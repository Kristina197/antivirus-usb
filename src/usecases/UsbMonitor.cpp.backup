#include "UsbMonitor.h"
#include <iostream>
#include <unistd.h>
#include <cstring>

UsbMonitor::UsbMonitor() : udev_(nullptr), monitor_(nullptr), running_(false) {
    udev_ = udev_new();
    if (!udev_) {
        std::cerr << "✗ Failed to create udev context" << std::endl;
        return;
    }
    
    monitor_ = udev_monitor_new_from_netlink(udev_, "udev");
    if (!monitor_) {
        std::cerr << "✗ Failed to create udev monitor" << std::endl;
        return;
    }
    
    udev_monitor_filter_add_match_subsystem_devtype(monitor_, "block", "disk");
    udev_monitor_enable_receiving(monitor_);
    
    std::cout << "✓ USB Monitor initialized" << std::endl;
}

UsbMonitor::~UsbMonitor() {
    stopMonitoring();
    
    if (monitor_) {
        udev_monitor_unref(monitor_);
    }
    if (udev_) {
        udev_unref(udev_);
    }
}

void UsbMonitor::startMonitoring() {
    if (running_) return;
    
    running_ = true;
    monitorThread_ = std::thread(&UsbMonitor::monitorLoop, this);
    
    std::cout << "✓ USB monitoring started" << std::endl;
}

void UsbMonitor::stopMonitoring() {
    if (!running_) return;
    
    running_ = false;
    if (monitorThread_.joinable()) {
        monitorThread_.join();
    }
    
    std::cout << "✓ USB monitoring stopped" << std::endl;
}

void UsbMonitor::monitorLoop() {
    int fd = udev_monitor_get_fd(monitor_);
    
    while (running_) {
        fd_set fds;
        FD_ZERO(&fds);
        FD_SET(fd, &fds);
        
        struct timeval tv;
        tv.tv_sec = 1;
        tv.tv_usec = 0;
        
        int ret = select(fd + 1, &fds, nullptr, nullptr, &tv);
        
        if (ret > 0 && FD_ISSET(fd, &fds)) {
            struct udev_device* dev = udev_monitor_receive_device(monitor_);
            if (!dev) continue;
            
            const char* action = udev_device_get_action(dev);
            const char* devnode = udev_device_get_devnode(dev);
            const char* id_bus = udev_device_get_property_value(dev, "ID_BUS");
            
            if (action && devnode && id_bus && strcmp(id_bus, "usb") == 0) {
                DeviceInfo device;
                device.deviceName = devnode;
                device.mountPoint = "/media/usb";
                
                if (strcmp(action, "add") == 0) {
                    std::cout << "✓ USB device connected: " << devnode << std::endl;
                    emit deviceConnected(device);
                } else if (strcmp(action, "remove") == 0) {
                    std::cout << "✓ USB device disconnected: " << devnode << std::endl;
                    emit deviceDisconnected(device);
                }
            }
            
            udev_device_unref(dev);
        }
    }
}
