#include "MainWindow.h"
#include <QThread>
#include "ui_MainWindow.h"
#include "ScanWorker.h"
#include "QuarantineDialog.h"
#include "SettingsDialog.h"
#include "ResultDialog.h"
#include <QMessageBox>
#include <QPushButton>
#include <QThread>
#include <QDateTime>
#include <QFileInfo>
#include <QDebug>

MainWindow::MainWindow(std::shared_ptr<VirusScanner> scanner,
                       std::shared_ptr<IUsbMonitor> usbMonitor,
                       std::shared_ptr<IDeviceRepository> deviceRepo,
                       std::shared_ptr<QuarantineManager> quarantineManager,
                       QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
    , scanner_(scanner)
    , usbMonitor_(usbMonitor)
    , deviceRepo_(deviceRepo)
    , quarantineManager_(quarantineManager)
    , scanThread_(nullptr)
{
    ui->setupUi(this);
    setWindowTitle("USB –ê–Ω—Ç–∏–≤–∏—Ä—É—Å");
    
    ui->scanButton->setText("–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ");
    ui->settingsButton->setText("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏");
    ui->quarantineButton->setText("üìÅ –ö–∞—Ä–∞–Ω—Ç–∏–Ω");
    
    setupConnections();
    setupDeviceTable();
    setupResultsTable();
    
    ui->statusLabel->setText("–ì–æ—Ç–æ–≤. –û–∂–∏–¥–∞–Ω–∏–µ USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤...");
    ui->progressBar->setVisible(false);
    
    qDebug() << "‚úì MainWindow initialized";
}

MainWindow::~MainWindow() {
    if (scanThread_ && scanThread_->isRunning()) {
        scanThread_->quit();
        scanThread_->wait();
    }
    delete ui;
}

void MainWindow::setupConnections() {
    connect(usbMonitor_.get(), &IUsbMonitor::deviceConnected, 
            this, &MainWindow::onDeviceConnected);
    connect(usbMonitor_.get(), &IUsbMonitor::deviceDisconnected, 
            this, &MainWindow::onDeviceDisconnected);
    
    connect(ui->scanButton, &QPushButton::clicked, 
            this, &MainWindow::onScanButtonClicked);
    connect(ui->quarantineButton, &QPushButton::clicked, 
            this, &MainWindow::onQuarantineButtonClicked);
    connect(ui->settingsButton, &QPushButton::clicked, 
            this, &MainWindow::onSettingsButtonClicked);
    
    usbMonitor_->startMonitoring();
}

void MainWindow::setupDeviceTable() {
    ui->deviceTable->setColumnCount(4);
    ui->deviceTable->setHorizontalHeaderLabels({"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", "–ü—É—Ç—å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", "–°—Ç–∞—Ç—É—Å", "–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"});
    ui->deviceTable->horizontalHeader()->setStretchLastSection(true);
    ui->deviceTable->setSelectionBehavior(QAbstractItemView::SelectRows);
    ui->deviceTable->setSelectionMode(QAbstractItemView::SingleSelection);
    ui->deviceTable->setEditTriggers(QAbstractItemView::NoEditTriggers);
}

void MainWindow::setupResultsTable() {
    ui->resultsTable->setColumnCount(3);
    ui->resultsTable->setHorizontalHeaderLabels({"–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É", "–°—Ç–∞—Ç—É—Å", "–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏—Ä—É—Å–∞"});
    ui->resultsTable->horizontalHeader()->setStretchLastSection(true);
    ui->resultsTable->setSelectionBehavior(QAbstractItemView::SelectRows);
    ui->resultsTable->setEditTriggers(QAbstractItemView::NoEditTriggers);
}

void MainWindow::onDeviceConnected(const DeviceInfo& device) {
    qDebug() << "Thread ID:" << QThread::currentThreadId() << ", Main thread:" << QCoreApplication::instance()->thread();
    qDebug() << "Device connected:" << QString::fromStdString(device.deviceName);
    qDebug() << "  mountPoint:" << QString::fromStdString(device.mountPoint);
    qDebug() << "  devicePath:" << QString::fromStdString(device.devicePath);
    
    int row = ui->deviceTable->rowCount();
    ui->deviceTable->insertRow(row);
    ui->deviceTable->setItem(row, 0, new QTableWidgetItem(QString::fromStdString(device.deviceName)));
    qDebug() << "  setItem(0) called, item pointer:" << ui->deviceTable->item(row, 0);
    ui->deviceTable->setItem(row, 1, new QTableWidgetItem(QString::fromStdString(device.mountPoint)));
    ui->deviceTable->setItem(row, 2, new QTableWidgetItem("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ"));
    ui->deviceTable->setItem(row, 3, new QTableWidgetItem("–ù–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å"));
    
    qDebug() << "‚úì Added device to table, row:" << row;
    qDebug() << "  Column 0:" << ui->deviceTable->item(row, 0)->text();
    qDebug() << "  Column 1:" << ui->deviceTable->item(row, 1)->text();
    
    connectedDevices_.push_back(device);
    
    ui->statusLabel->setText(QString("USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ: %1").arg(QString::fromStdString(device.deviceName)));
    
    QMessageBox::StandardButton reply = QMessageBox::question(
        this, "USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ",
        QString("USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ '%1' –±—ã–ª–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.\n–•–æ—Ç–∏—Ç–µ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å–µ–π—á–∞—Å?")
            .arg(QString::fromStdString(device.deviceName)),
        QMessageBox::Yes | QMessageBox::No
    );
    
    if (reply == QMessageBox::Yes) {
        scanDevice(device);
    }
}

void MainWindow::onDeviceDisconnected(const DeviceInfo& device) {
    qDebug() << "Device disconnected:" << QString::fromStdString(device.deviceName);
    
    for (int row = 0; row < ui->deviceTable->rowCount(); ++row) {
        QTableWidgetItem* mountItem = ui->deviceTable->item(row, 1);
        if (mountItem && mountItem->text().toStdString() == device.mountPoint) {
            ui->deviceTable->removeRow(row);
            break;
        }
    }
    
    ui->statusLabel->setText(QString("USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ: %1").arg(QString::fromStdString(device.deviceName)));
}

void MainWindow::onScanButtonClicked() {
    int currentRow = ui->deviceTable->currentRow();
    if (currentRow < 0) {
        QMessageBox::warning(this, "–ù–µ –≤—ã–±—Ä–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.");
        return;
    }
    
    if (currentRow >= connectedDevices_.size()) return;
    DeviceInfo device = connectedDevices_[currentRow];
    
    scanDevice(device);
}

void MainWindow::onQuarantineButtonClicked() {
    QuarantineDialog dialog(quarantineManager_, this);
    dialog.exec();
}

void MainWindow::onSettingsButtonClicked() {
    SettingsDialog dialog(scanner_->getScanConfig(), this);
    if (dialog.exec() == QDialog::Accepted) {
        ui->statusLabel->setText("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
    }
}

void MainWindow::scanDevice(const DeviceInfo& device) {
    if (scanThread_ && scanThread_->isRunning()) {
        QMessageBox::warning(this, "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è", 
                           "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.");
        return;
    }
    
    ui->resultsTable->setRowCount(0);
    ui->progressBar->setVisible(true);
    ui->progressBar->setRange(0, 0);
    ui->scanButton->setEnabled(false);
    ui->statusLabel->setText(QString("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ %1...").arg(QString::fromStdString(device.deviceName)));
    
    scanThread_ = new QThread;
    ScanWorker* worker = new ScanWorker(scanner_, device);
    worker->moveToThread(scanThread_);
    
    connect(scanThread_, &QThread::started, worker, &ScanWorker::doScan);
    connect(worker, &ScanWorker::scanFinished, this, 
            [this, device](const std::vector<ScanResult>& results) {
                onScanFinished(device, results);
            });
    connect(worker, &ScanWorker::scanFinished, scanThread_, &QThread::quit);
    connect(scanThread_, &QThread::finished, worker, &QObject::deleteLater);
    connect(scanThread_, &QThread::finished, scanThread_, &QObject::deleteLater);
    
    scanThread_->start();
}

void MainWindow::onScanFinished(const DeviceInfo& device, const std::vector<ScanResult>& results) {
    ui->progressBar->setVisible(false);
    ui->scanButton->setEnabled(true);
    
    int threatsFound = 0;
    int totalFiles = results.size();
    std::vector<ScanResult> infectedFiles;
    
    for (const auto& result : results) {
        if (result.isInfected) {
            infectedFiles.push_back(result);
            threatsFound++;
            
            int row = ui->resultsTable->rowCount();
            ui->resultsTable->insertRow(row);
            ui->resultsTable->setItem(row, 0, new QTableWidgetItem(QString::fromStdString(result.filePath)));
            ui->resultsTable->setItem(row, 1, new QTableWidgetItem("‚ö†Ô∏è –ó–∞—Ä–∞–∂–µ–Ω"));
            ui->resultsTable->setItem(row, 2, new QTableWidgetItem(QString::fromStdString(result.virusName)));
        }
    }
    
    for (int row = 0; row < ui->deviceTable->rowCount(); ++row) {
        QTableWidgetItem* mountItem = ui->deviceTable->item(row, 1);
        if (mountItem && mountItem->text().toStdString() == device.mountPoint) {
            QString status = threatsFound > 0 ? 
                QString("%1 —É–≥—Ä–æ–∑").arg(threatsFound) : "–ß–∏—Å—Ç–æ";
            ui->deviceTable->setItem(row, 2, new QTableWidgetItem(status));
            ui->deviceTable->setItem(row, 3, new QTableWidgetItem(
                QDateTime::currentDateTime().toString("yyyy-MM-dd HH:mm:ss")));
            break;
        }
    }
    
    if (threatsFound > 0) {
        ui->statusLabel->setText(QString("‚ö†Ô∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –Ω–∞–π–¥–µ–Ω–æ %1 —É–≥—Ä–æ–∑!").arg(threatsFound));
        
        // üîç DEBUG
        qDebug() << "=== DEBUG: About to show ResultDialog ===";
        qDebug() << "Threats found:" << threatsFound;
        qDebug() << "Total files:" << totalFiles;
        
        // 1Ô∏è‚É£ –ü–û–ö–ê–ó–´–í–ê–ï–ú –û–ö–ù–û –° –ò–ö–û–ù–ö–û–ô
        ResultDialog::showInfectedResult(this, threatsFound, totalFiles);
        
        qDebug() << "=== DEBUG: ResultDialog closed ===";
        
        // 2Ô∏è‚É£ –î–õ–Ø –ö–ê–ñ–î–û–ì–û –§–ê–ô–õ–ê –í–´–ë–û–†
        for (const auto& result : infectedFiles) {
            qDebug() << "Showing dialog for file:" << QString::fromStdString(result.filePath);
            handleInfectedFile(QString::fromStdString(result.filePath), 
                             QString::fromStdString(result.virusName));
        }
        
    } else {
        ui->statusLabel->setText("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: —É–≥—Ä–æ–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        ResultDialog::showCleanResult(this, totalFiles);
    }
    
    scanThread_ = nullptr;
}

void MainWindow::showThreatSummary(int threatsFound, int totalFiles) {
    // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
}

void MainWindow::handleInfectedFile(const QString& filePath, const QString& virusName) {
    QMessageBox msgBox(this);
    msgBox.setWindowTitle("‚ö†Ô∏è –£–≥—Ä–æ–∑–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞");
    msgBox.setIcon(QMessageBox::Warning);
    msgBox.setText(QString("<h3>–û–±–Ω–∞—Ä—É–∂–µ–Ω –≤–∏—Ä—É—Å: <font color='red'>%1</font></h3>").arg(virusName));
    msgBox.setInformativeText(QString("<b>–§–∞–π–ª:</b><br>%1<br><br><b>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</b>").arg(filePath));
    
    QPushButton* quarantineBtn = msgBox.addButton("üîí –ü–æ–º–µ—Å—Ç–∏—Ç—å –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω", QMessageBox::AcceptRole);
    QPushButton* ignoreBtn = msgBox.addButton("‚ùå –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å", QMessageBox::RejectRole);
    msgBox.setDefaultButton(quarantineBtn);
    
    msgBox.exec();
    
    if (msgBox.clickedButton() == quarantineBtn) {
        if (quarantineManager_->quarantineFile(filePath.toStdString(), virusName.toStdString())) {
            QMessageBox::information(this, "‚úÖ –£—Å–ø–µ—à–Ω–æ", 
                QString("–§–∞–π–ª <b>%1</b> –ø–æ–º–µ—â–µ–Ω –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω").arg(QFileInfo(filePath).fileName()));
        } else {
            QMessageBox::critical(this, "‚ùå –û—à–∏–±–∫–∞", 
                "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª –≤ –∫–∞—Ä–∞–Ω—Ç–∏–Ω");
        }
    } else {
        qDebug() << "‚ö†Ô∏è User chose to ignore infected file:" << filePath;
        QMessageBox::warning(this, "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", 
            "–§–∞–π–ª –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –¥–∏—Å–∫–µ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–µ–Ω!");
    }
}
